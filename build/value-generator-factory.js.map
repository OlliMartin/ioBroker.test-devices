{
  "version": 3,
  "sources": ["../src/value-generator-factory.ts"],
  "sourcesContent": ["import { commonValueGenerators } from './value-generator.defs';\nimport { UNIT__CUSTOM, UNIT__TYPE_MATCH } from './constants';\nimport { getFallbackValueGenerator } from './value-generators';\n\nconst getValueGeneratorRelevance = (vg: ioBroker.ValueGeneratorDefinition): number => {\n\tlet result = 0;\n\tif (vg.u !== UNIT__CUSTOM && vg.u !== UNIT__TYPE_MATCH) {\n\t\tresult += 2;\n\t}\n\n\tif (vg.d) {\n\t\tresult += 3;\n\t}\n\n\tif (vg.s) {\n\t\tresult += 1;\n\t}\n\treturn result;\n};\n\nexport const getValueGenerator = (\n\tstateDefinition: ioBroker.DeviceStateDefinition,\n\ttrackGeneratorCb?: (sd: ioBroker.DeviceStateDefinition, vg: ioBroker.ValueGeneratorDefinition[]) => void,\n): ioBroker.ValueGenerator<ioBroker.StateValue> => {\n\ttrackGeneratorCb ??= (sd: ioBroker.DeviceStateDefinition, vg: ioBroker.ValueGeneratorDefinition[]): void => {\n\t\tif (vg.length > 1) {\n\t\t\tconsole.log(\n\t\t\t\t`Warning: Identified more than one value generator for ${sd.device.name}:${sd.state.name} (${sd.commonType}).`,\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!vg[0].isFallback) {\n\t\t\treturn;\n\t\t}\n\t\tconsole.log(`Warning: Fallback used for ${sd.device.name}:${sd.state.name} (${sd.commonType}).`);\n\t};\n\n\tconst exactGeneratorMatches = commonValueGenerators.filter(\n\t\tvgDef =>\n\t\t\tvgDef.u === stateDefinition.state.defaultUnit &&\n\t\t\tvgDef.t === stateDefinition.commonType &&\n\t\t\t(vgDef.d === undefined || vgDef.d.includes(stateDefinition.device.name)) &&\n\t\t\t(vgDef.s === undefined || vgDef.s.includes(stateDefinition.state.name)),\n\t);\n\n\tif (exactGeneratorMatches.length === 1) {\n\t\ttrackGeneratorCb(stateDefinition, exactGeneratorMatches);\n\t\treturn exactGeneratorMatches[0].gen;\n\t} else if (exactGeneratorMatches.length > 1) {\n\t\tconst genSortedByApplicability = exactGeneratorMatches.sort(\n\t\t\t(a, b) => getValueGeneratorRelevance(b) - getValueGeneratorRelevance(a),\n\t\t);\n\n\t\tif (\n\t\t\tgetValueGeneratorRelevance(genSortedByApplicability[0]) ==\n\t\t\tgetValueGeneratorRelevance(genSortedByApplicability[1])\n\t\t) {\n\t\t\ttrackGeneratorCb(stateDefinition, genSortedByApplicability);\n\t\t\treturn genSortedByApplicability[0].gen;\n\t\t}\n\n\t\ttrackGeneratorCb(stateDefinition, [genSortedByApplicability[0]]);\n\t\treturn genSortedByApplicability[0].gen;\n\t}\n\n\tconst customMatches = commonValueGenerators.filter(\n\t\tvgDef =>\n\t\t\tvgDef.u === '%%CUSTOM%%' &&\n\t\t\tvgDef.t === stateDefinition.commonType &&\n\t\t\t(vgDef.d === undefined || vgDef.d.includes(stateDefinition.device.name)) &&\n\t\t\t(vgDef.s === undefined || vgDef.s.includes(stateDefinition.state.name)),\n\t);\n\n\tif (customMatches.length === 1) {\n\t\ttrackGeneratorCb(stateDefinition, customMatches);\n\t\treturn customMatches[0].gen;\n\t}\n\n\tconst typeMatches = commonValueGenerators.filter(\n\t\tvgDef => vgDef.u === '%%TYPE_MATCH%%' && vgDef.t === stateDefinition.commonType,\n\t);\n\n\tif (typeMatches.length === 1) {\n\t\ttrackGeneratorCb(stateDefinition, typeMatches);\n\t\treturn typeMatches[0].gen;\n\t}\n\n\treturn getFallbackValueGenerator();\n};\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAAsC;AACtC,uBAA+C;AAC/C,8BAA0C;AAE1C,MAAM,6BAA6B,CAAC,OAAkD;AACrF,MAAI,SAAS;AACb,MAAI,GAAG,MAAM,iCAAgB,GAAG,MAAM,mCAAkB;AACvD,cAAU;AAAA,EACX;AAEA,MAAI,GAAG,GAAG;AACT,cAAU;AAAA,EACX;AAEA,MAAI,GAAG,GAAG;AACT,cAAU;AAAA,EACX;AACA,SAAO;AACR;AAEO,MAAM,oBAAoB,CAChC,iBACA,qBACkD;AAClD,mEAAqB,CAAC,IAAoC,OAAkD;AAC3G,QAAI,GAAG,SAAS,GAAG;AAClB,cAAQ;AAAA,QACP,yDAAyD,GAAG,OAAO,IAAI,IAAI,GAAG,MAAM,IAAI,KAAK,GAAG,UAAU;AAAA,MAC3G;AACA;AAAA,IACD;AAEA,QAAI,CAAC,GAAG,CAAC,EAAE,YAAY;AACtB;AAAA,IACD;AACA,YAAQ,IAAI,8BAA8B,GAAG,OAAO,IAAI,IAAI,GAAG,MAAM,IAAI,KAAK,GAAG,UAAU,IAAI;AAAA,EAChG;AAEA,QAAM,wBAAwB,6CAAsB;AAAA,IACnD,WACC,MAAM,MAAM,gBAAgB,MAAM,eAClC,MAAM,MAAM,gBAAgB,eAC3B,MAAM,MAAM,UAAa,MAAM,EAAE,SAAS,gBAAgB,OAAO,IAAI,OACrE,MAAM,MAAM,UAAa,MAAM,EAAE,SAAS,gBAAgB,MAAM,IAAI;AAAA,EACvE;AAEA,MAAI,sBAAsB,WAAW,GAAG;AACvC,qBAAiB,iBAAiB,qBAAqB;AACvD,WAAO,sBAAsB,CAAC,EAAE;AAAA,EACjC,WAAW,sBAAsB,SAAS,GAAG;AAC5C,UAAM,2BAA2B,sBAAsB;AAAA,MACtD,CAAC,GAAG,MAAM,2BAA2B,CAAC,IAAI,2BAA2B,CAAC;AAAA,IACvE;AAEA,QACC,2BAA2B,yBAAyB,CAAC,CAAC,KACtD,2BAA2B,yBAAyB,CAAC,CAAC,GACrD;AACD,uBAAiB,iBAAiB,wBAAwB;AAC1D,aAAO,yBAAyB,CAAC,EAAE;AAAA,IACpC;AAEA,qBAAiB,iBAAiB,CAAC,yBAAyB,CAAC,CAAC,CAAC;AAC/D,WAAO,yBAAyB,CAAC,EAAE;AAAA,EACpC;AAEA,QAAM,gBAAgB,6CAAsB;AAAA,IAC3C,WACC,MAAM,MAAM,gBACZ,MAAM,MAAM,gBAAgB,eAC3B,MAAM,MAAM,UAAa,MAAM,EAAE,SAAS,gBAAgB,OAAO,IAAI,OACrE,MAAM,MAAM,UAAa,MAAM,EAAE,SAAS,gBAAgB,MAAM,IAAI;AAAA,EACvE;AAEA,MAAI,cAAc,WAAW,GAAG;AAC/B,qBAAiB,iBAAiB,aAAa;AAC/C,WAAO,cAAc,CAAC,EAAE;AAAA,EACzB;AAEA,QAAM,cAAc,6CAAsB;AAAA,IACzC,WAAS,MAAM,MAAM,oBAAoB,MAAM,MAAM,gBAAgB;AAAA,EACtE;AAEA,MAAI,YAAY,WAAW,GAAG;AAC7B,qBAAiB,iBAAiB,WAAW;AAC7C,WAAO,YAAY,CAAC,EAAE;AAAA,EACvB;AAEA,aAAO,mDAA0B;AAClC;",
  "names": []
}
